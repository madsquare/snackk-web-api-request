!function(e,t){"function"==typeof define?define(["jquery","jquery-cookie","jquery-iframe-transport","lodash"],t):"object"==typeof exports?module.exports=t():e.request=t()}(this,function(){var e,t,r;return function(n){function o(e,t){var r,n,o,s,u,a,i,c,p,l,f=t&&t.split("/"),h=y.map,d=h&&h["*"]||{};if(e&&"."===e.charAt(0)&&t){for(f=f.slice(0,f.length-1),e=f.concat(e.split("/")),c=0;l=e[c];c++)if("."===l)e.splice(c,1),c-=1;else if(".."===l){if(1===c&&(".."===e[2]||".."===e[0]))return!0;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}if((f||d)&&h){for(r=e.split("/"),c=r.length;c>0;c-=1){if(n=r.slice(0,c).join("/"),f)for(p=f.length;p>0;p-=1)if(o=h[f.slice(0,p).join("/")],o&&(o=o[n])){s=o,u=c;break}if(s)break;!a&&d&&d[n]&&(a=d[n],i=c)}!s&&a&&(s=a,u=i),s&&(r.splice(0,u,s),e=r.join("/"))}return e}function s(e,t){return function(){return f.apply(n,_.call(arguments,0).concat([e,t]))}}function u(e){return function(t){return o(t,e)}}function a(e){return function(t){h[e]=t}}function i(e){if(d.hasOwnProperty(e)){var t=d[e];delete d[e],T[e]=!0,l.apply(n,t)}if(!h.hasOwnProperty(e))throw new Error("No "+e);return h[e]}function c(e,t){var r,n,s=e.indexOf("!");return-1!==s?(r=o(e.slice(0,s),t),e=e.slice(s+1),n=i(r),e=n&&n.normalize?n.normalize(e,u(t)):o(e,t)):e=o(e,t),{f:r?r+"!"+e:e,n:e,p:n}}function p(e){return function(){return y&&y.config&&y.config[e]||{}}}var l,f,h={},d={},y={},T={},_=[].slice;l=function(e,t,r,o){var u,l,f,y,_,m,g=[];if(o=o||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,m=0;m<t.length;m++)if(_=c(t[m],o),f=_.f,"require"===f)g[m]=s(e);else if("exports"===f)g[m]=h[e]={},u=!0;else if("module"===f)l=g[m]={id:e,uri:"",exports:h[e],config:p(e)};else if(h.hasOwnProperty(f)||d.hasOwnProperty(f))g[m]=i(f);else if(_.p)_.p.load(_.n,s(o,!0),a(f),{}),g[m]=h[f];else if(!T[f])throw new Error(e+" missing "+f);y=r.apply(h[e],g),e&&(l&&l.exports!==n&&l.exports!==h[e]?h[e]=l.exports:y===n&&u||(h[e]=y))}else e&&(h[e]=r)},e=t=f=function(e,t,r,o){return"string"==typeof e?i(c(e,t).f):(e.splice||(y=e,t.splice?(e=t,t=r,r=null):e=n),t=t||function(){},o?l(n,e,t,r):setTimeout(function(){l(n,e,t,r)},15),f)},f.config=function(e){return y=e,f},r=function(e,t,r){t.splice||(r=t,t=[]),d[e]=[e,t,r]},r.amd={jQuery:!0}}(),r("../almond",function(){}),function(){r("request",["lodash","jquery","jquery-iframe-transport"],function(e,t){var r,n,o,s,u;return u="v2",s={"X-SNACKK-CLIENT-ID":null,"X-SNACKK-CLIENT-SECRET":null,"X-SNACKK-TZ-OFFSET":null,"X-SNACKK-COUNTRY":null,"X-SNACKK-APP-VER":null},o=null,n={REFRESHING:"token.refresh",NOT_EXIST_TOKEN:"token.not_exist"},r=function(){function r(e){return this.setHeaderObj(e),o=e.baseUrl,this.tokenModule=e.tokenModule,this.env=e.env,this}return r.prototype.refreshRequestQueue=[],r.prototype.options=null,r.prototype.state=null,r.prototype.hasRequest={},r.prototype.requestData={},r.prototype.timeoutDuration=7e3,r.prototype.env=null,r.prototype.setHeaderObj=function(e){return s["X-SNACKK-CLIENT-ID"]=e.clientId,s["X-SNACKK-CLIENT-SECRET"]=e.clientSecret,s["X-SNACKK-TZ-OFFSET"]=(new Date).getTimezoneOffset(),s["X-SNACKK-COUNTRY"]="KR",s["X-SNACKK-APP-VER"]=Number(e.versionCode),-1!==location.hostname.indexOf("cn")?s["X-SNACKK-COUNTRY"]="CN":-1!==location.hostname.indexOf("snackk.me")?(s["X-SNACKK-COUNTRY"]="TW",s["Accept-Language"]="zh-TW"):void 0},r.prototype.request=function(r,u){var a,i,c,p,l,f,h,d,y,T,_,m;if(f={url:o+r,type:"GET",headers:t.extend({},s,!0),dataType:"json",contentType:"application/json; charset=utf-8"},y=r+JSON.stringify(u.data),T=r,this.hasRequest[y])return console.info("server] request ignore :"+y),this.hasRequest[y];if(this.state===n.REFRESHING&&"auth/refresh"!==T)return console.debug("token-expired] queue.push : "+T+" / "+JSON.stringify(u)),void this.refreshRequestQueue.push({url:T,data:u});if("undefined"!=typeof u.type&&(f.type=u.type),"undefined"!=typeof u.dataType&&(f.dataType=u.dataType),"undefined"!=typeof u.data&&u.type)f.data=JSON.stringify(u.data);else if(u.data){f.data=u.data,d=u.data;for(l in d)m=d[l],("object"==typeof m||"array"==typeof m)&&(f.data[l]=JSON.stringify(m))}else f.data=u.data;return u.headers&&(f.headers=e.assign(f.headers,u.headers)),t.inArray(f.type,["PUT","DELETE"])>-1&&(f.headers["X-HTTP-Method-Override"]=f.type,f.type="POST"),console.log("getAccessToken: "+this.tokenModule.getAccessToken()),(a=this.tokenModule.getAccessToken())&&this.state!==n.REFRESHING&&(f.headers.Authorization="Bearer "+a),this.requestData[y]=u,i=function(e){return function(){return delete e.hasRequest[y],delete e.requestData[y]}}(this),c=function(e){return function(t,r,n){return _&&clearTimeout(_),e.repeatTokenRequestCount=0,i(),"string"==typeof t.nonce&&(t.nonce=JSON.parse(t.nonce)),e.done(t,r,n),u.success&&u.success(t,r,n)}}(this),p=function(e){return function(t){var o,s;if(_&&clearTimeout(_),!t)return console.error("server-error] 반환된 error객체가 없음."),!1;if(i(),0===t.readyState||"abort"===t.statusText||"No Transport"===t.statusText)return!1;if(t.responseText&&(s=JSON.parse(t.responseText),s&&(o=s.error)),o&&"common.expired_access_token"===o.type){if("auth/refresh"!==T&&(console.debug("token-expired] queue.push : "+T+" / "+JSON.stringify(u)),e.refreshRequestQueue.push({url:T,data:u})),e.state!==n.REFRESHING)return e.state=n.REFRESHING,e.refreshToken({success:function(t){var r,n;e.state=null;try{for("string"==typeof t&&(t=JSON.parse(t.responseText)),e.tokenModule.setToken(t.token),r=0,n=[];r<e.refreshRequestQueue.length;)console.debug("token-expired] queue.실행 : "+e.refreshRequestQueue[r].url),e.request(e.refreshRequestQueue[r].url,e.refreshRequestQueue[r].data),n.push(e.refreshRequestQueue.shift());return n}catch(s){o=s}},error:function(e){}}),t}else{if(o&&"common.not_exist_token"===o.type)return e.state!==n.NOT_EXIST_TOKEN&&"auth/refresh"!==r?(e.state=n.NOT_EXIST_TOKEN,e.repeatTokenRequestCount++,e.request(r,u),t):void e.responseInvalidToken();(u.error&&u.error(o))!==!1&&o&&500!==o.code&&setTimeout(function(){return e.responseError(o.message)},100)}return e.fail(t),t}}(this),-1!==f.dataType.indexOf("iframe")&&(h=c,c=function(e,t,r){return e&&"undefined"==typeof e.error?h(e,t,r):p(e)},f.method="POST",f.formData=[],f.data||(f.data={}),"undefined"!=typeof f.headers.Authorization?(f.data.access_token=f.headers.Authorization,f.data.x_snackk_country=f.headers["X-SNACKK-COUNTRY"]):(f.data.client_id=f.headers["X-SNACKK-CLIENT-ID"],f.data.client_secret=f.headers["X-SNACKK-CLIENT-SECRET"],f.data.x_snackk_country=f.headers["X-SNACKK-COUNTRY"]),f.data.redirect=[location.protocol,"//",location.host].join("")+"/result?%s",8e3===parseInt(location.port,10)&&(f.data.redirect=[location.protocol,"//",location.host].join("")+"/result.html?%s"),e.forEach(f.data,function(e,t){return f.formData.push({name:t,value:e})}),f.fileInput=u.fileInput),_=setTimeout(function(e){return function(){return e.timeoutReqeust()}}(this),this.timeoutDuration),this.beforeRequest(),f.success=c,f.error=p,f.complete=u.complete,this.hasRequest[r]={},this.hasRequest[r].reqId=y,this.hasRequest[r].request=this.hasRequest[y]=t.ajax(f)},r.prototype.refreshToken=function(e){return this.request("auth/refresh",{type:"POST",data:{refresh_token:this.tokenModule.getRefreshToken()},success:function(t){return function(t){return e&&e.success&&e.success(t)}}(this),error:function(t){return e&&e.error&&e.error(t)},complete:function(t){return e&&e.complete&&e.complete(t)}})},r.prototype.beforeRequest=function(e){},r.prototype.fail=function(e){},r.prototype.done=function(e,t,r){},r.prototype.timeoutReqeust=function(){},r.prototype.responseInvalidToken=function(){},r.prototype.responseError=function(e){},r.prototype.TAG={auth:{refresh:"auth/refresh",clear:"auth/clear",authorize:"auth/authorize"},app:{tvs:"app/tvs",facebooktv:"app/facebooktv"},notice:"app/web",search:{target:"search/:target",url:"videos/validate"},channel:"channels/:ch_no",channels:{get:"channels",url:"channels/:url",subscribers:"channels/:ch_no/subscribers",resource:"channels/:ch_no/resources"},comment:{get:"channels/:ch_no/comments",unit:"channels/:ch_no/comments/:cc_no"},resources:{postTemporaryResources:"user/:us_no/channels/:ch_no/resources/:operation",putTemporaryResources:"user/:us_no/channels/:ch_no/resources/:cr_no",temporaryResourcesExclude:"user/:us_no/channels/:ch_no/resources/all/:operation",temporaryResources:"user/:us_no/channels/:ch_no/resources",temporaryExclude:"user/:us_no/channels/:ch_no/resources/truncate",cancelTemporary:"user/:us_no/channels/:ch_no/histories/:hi_no"},storage:{storage:"user/:us_no/resources",storageProvider:"user/:us_no/resources/:provider",storageExclude:"user/:us_no/resources/truncate"},resource:"resources/:rs_no",user:{get:"user",unit:"user/:us_no",emailPost:"user/email/verify",profile:"user/:us_no/picture",profileDefault:"user/:us_no/picture/default",channels:"user/:us_no/channels",subscriptions:"user/:us_no/subscriptions",subscribe:"user/:us_no/subscriptions/:ch_no",channel:"user/:us_no/channels/:ch_no",channelLogo:"user/:us_no/channels/:ch_no/logo",channelLogoDefault:"channels/:ch_no/logo/default",provider:"user/:us_no/sns/:provider",resource:"user/:us_no/resources/:rs_no",password:"user/passwd"},report:"reports",activity:{getActivities:"activities",read:"activities/read"},category:{categories:"categories",channels:"categories/:ca_no/channels"},timeline:{channels:"timelines/channels"},stat:{total:"channels/:ch_no/stats/:begin/:end/:step",rank:"channels/:ch_no/stats/ranking"},event:{post:"events/applicants/:target"},posts:"posts",post:{unit:"posts/:po_no",comments:"posts/:po_no/comments",likes:"posts/:po_no/likes",inPost:"posts/:po_no/posts"}},r}()})}.call(this),r("jquery",function(){return $}),r("jquery-iframe-transport",function(){}),r("lodash",function(){return _}),t("request")});
//# sourceMappingURL=snackk-web-api-request.min.js.map