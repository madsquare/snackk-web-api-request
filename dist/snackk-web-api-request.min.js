!function(e,t){"function"==typeof define?define(["jquery","jquery-cookie","jquery-iframe-transport","lodash"],t):"object"==typeof exports?module.exports=t():e.request=t()}(this,function(){var e,t,r;return function(n){function o(e,t){var r,n,o,s,u,i,a,c,h,f,l=t&&t.split("/"),p=T.map,d=p&&p["*"]||{};if(e&&"."===e.charAt(0)&&t){for(l=l.slice(0,l.length-1),e=l.concat(e.split("/")),c=0;f=e[c];c++)if("."===f)e.splice(c,1),c-=1;else if(".."===f){if(1===c&&(".."===e[2]||".."===e[0]))return!0;c>0&&(e.splice(c-1,2),c-=2)}e=e.join("/")}if((l||d)&&p){for(r=e.split("/"),c=r.length;c>0;c-=1){if(n=r.slice(0,c).join("/"),l)for(h=l.length;h>0;h-=1)if(o=p[l.slice(0,h).join("/")],o&&(o=o[n])){s=o,u=c;break}if(s)break;!i&&d&&d[n]&&(i=d[n],a=c)}!s&&i&&(s=i,u=a),s&&(r.splice(0,u,s),e=r.join("/"))}return e}function s(e,t){return function(){return l.apply(n,k.call(arguments,0).concat([e,t]))}}function u(e){return function(t){return o(t,e)}}function i(e){return function(t){p[e]=t}}function a(e){if(d.hasOwnProperty(e)){var t=d[e];delete d[e],m[e]=!0,f.apply(n,t)}if(!p.hasOwnProperty(e))throw new Error("No "+e);return p[e]}function c(e,t){var r,n,s=e.indexOf("!");return-1!==s?(r=o(e.slice(0,s),t),e=e.slice(s+1),n=a(r),e=n&&n.normalize?n.normalize(e,u(t)):o(e,t)):e=o(e,t),{f:r?r+"!"+e:e,n:e,p:n}}function h(e){return function(){return T&&T.config&&T.config[e]||{}}}var f,l,p={},d={},T={},m={},k=[].slice;f=function(e,t,r,o){var u,f,l,T,k,y,_=[];if(o=o||e,"function"==typeof r){for(t=!t.length&&r.length?["require","exports","module"]:t,y=0;y<t.length;y++)if(k=c(t[y],o),l=k.f,"require"===l)_[y]=s(e);else if("exports"===l)_[y]=p[e]={},u=!0;else if("module"===l)f=_[y]={id:e,uri:"",exports:p[e],config:h(e)};else if(p.hasOwnProperty(l)||d.hasOwnProperty(l))_[y]=a(l);else if(k.p)k.p.load(k.n,s(o,!0),i(l),{}),_[y]=p[l];else if(!m[l])throw new Error(e+" missing "+l);T=r.apply(p[e],_),e&&(f&&f.exports!==n&&f.exports!==p[e]?p[e]=f.exports:T===n&&u||(p[e]=T))}else e&&(p[e]=r)},e=t=l=function(e,t,r,o){return"string"==typeof e?a(c(e,t).f):(e.splice||(T=e,t.splice?(e=t,t=r,r=null):e=n),t=t||function(){},o?f(n,e,t,r):setTimeout(function(){f(n,e,t,r)},15),l)},l.config=function(e){return T=e,l},r=function(e,t,r){t.splice||(r=t,t=[]),d[e]=[e,t,r]},r.amd={jQuery:!0}}(),r("../almond",function(){}),function(){r("token",[],function(){var e,t,r;return r=null,t=null,$.cookie.defaults.path="/",e={TAG:{accessToken:"access_token",refreshToken:"refresh_token",remember:"snackk_remember",sid:"snackk_sid"},init:function(e){return"undefiend"!=typeof e&&(e={access_token:$.cookie(this.TAG.accessToken)||"",refresh_token:$.cookie(this.TAG.refreshToken)||""}),this.setToken(e)},getAccessToken:function(){return null!==r?r.accessToken:null},getRefreshToken:function(){return null!==r?r.refreshToken:null},getSid:function(){return null===t&&(t=$.cookie(this.TAG.sid)||this.generateSid(),$.cookie(this.TAG.sid,t,{path:"/",expires:365})),t},setToken:function(e){var t,n;if(null!==e&&e.access_token&&e.refresh_token)return r={accessToken:e.access_token,refreshToken:e.refresh_token},t={path:"/"},n=parseInt($.cookie(this.TAG.remember)||0,10),1===n&&(t.expires=7),$.cookie(this.TAG.accessToken,r.accessToken,t),$.cookie(this.TAG.refreshToken,r.refreshToken,t),$.cookie(this.TAG.remember,n,t)},clear:function(){return r=null,$.removeCookie(this.TAG.accessToken),$.removeCookie(this.TAG.refreshToken),$.removeCookie(this.TAG.remember)},enableRemember:function(){return $.cookie(this.TAG.remember,1,{expires:7}),this.setToken(r)},disableRemember:function(){return $.removeCookie($TAG.remember),this.setToken(r)},generateSid:function(){var e,t,r;for(r="",e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=6;t-=1;)r+=e.charAt(Math.floor(Math.random()*e.length));return r}}})}.call(this),function(){r("request",["token"],function(e){var t,r,n,o,s;return s="v2",o={"X-SNACKK-CLIENT-ID":null,"X-SNACKK-CLIENT-SECRET":null,"X-SNACKK-TZ-OFFSET":null,"X-SNACKK-COUNTRY":null,"X-SNACKK-APP-VER":null},n=null,r={REFRESHING:"token.refresh",NOT_EXIST_TOKEN:"token.not_exist"},t=function(){function t(t){e.init(),this.setHeaderObj(t),n=t.baseUrl}return t.prototype.refreshRequestQueue=[],t.prototype.options=null,t.prototype.state=null,t.prototype.hasRequest={},t.prototype.requestData={},t.prototype.timeoutDuration=7e3,t.prototype.setHeaderObj=function(e){return o["X-SNACKK-CLIENT-ID"]=e.clientId,o["X-SNACKK-CLIENT-SECRET"]=e.clientSecret,o["X-SNACKK-TZ-OFFSET"]=(new Date).getTimezoneOffset(),o["X-SNACKK-COUNTRY"]="KR",o["X-SNACKK-APP-VER"]=Number(e.versionCode),-1!==location.hostname.indexOf("cn")?o["X-SNACKK-COUNTRY"]="CN":-1!==location.hostname.indexOf("snackk.me")?(o["X-SNACKK-COUNTRY"]="TW",o["Accept-Language"]="zh-TW"):void 0},t.prototype.request=function(t,s){var u,i,a,c,h,f,l,p,d,T,m,k;if(f={url:n+t,type:"GET",headers:o,dataType:"json",contentType:"application/json; charset=utf-8"},d=t+JSON.stringify(s.data),T=t,this.hasRequest[d])return console.info("server] request ignore :"+d),this.hasRequest[d];if(this.state===r.REFRESHING&&"auth/refresh"!==T)return console.debug("token-expired] queue.push : "+T+" / "+JSON.stringify(s)),void this.refreshRequestQueue.push({url:T,data:s});if("undefined"!=typeof s.type&&(f.type=s.type),"undefined"!=typeof s.dataType&&(f.dataType=s.dataType),"undefined"!=typeof s.data&&s.type)f.data=JSON.stringify(s.data);else if(s.data){f.data=s.data,p=s.data;for(h in p)k=p[h],("object"==typeof k||"array"==typeof k)&&(f.data[h]=JSON.stringify(k))}else f.data=s.data;return s.headers&&(f.headers=_.assign(f.headers,s.headers)),$.inArray(f.type,["PUT","DELETE"])>-1&&(f.headers["X-HTTP-Method-Override"]=f.type,f.type="POST"),(u=e.getAccessToken())&&this.state!==r.REFRESHING&&(f.headers.Authorization="Bearer "+u),this.requestData[d]=s,i=function(e){return function(){return delete e.hasRequest[d],delete e.requestData[d]}}(this),a=function(e){return function(t,r,n){return m&&clearTimeout(m),e.repeatTokenRequestCount=0,i(),"string"==typeof t.nonce&&(t.nonce=JSON.parse(t.nonce)),e.done(t,r,n),s.success&&s.success(t,r,n)}}(this),c=function(n){return function(o){var u,a;if(m&&clearTimeout(m),!o)return console.error("server-error] 반환된 error객체가 없음."),!1;if(i(),0===o.readyState||"abort"===o.statusText||"No Transport"===o.statusText)return!1;if(o.responseText&&(a=JSON.parse(o.responseText),a&&(u=a.error)),u&&"common.expired_access_token"===u.type){if("auth/refresh"!==T&&(console.debug("token-expired] queue.push : "+T+" / "+JSON.stringify(s)),n.refreshRequestQueue.push({url:T,data:s})),n.state!==r.REFRESHING)return n.state=r.REFRESHING,n.refreshToken({success:function(t){var r,o;n.state=null;try{for("string"==typeof t&&(t=JSON.parse(t.responseText)),e.setToken(t.token),r=0,o=[];r<n.refreshRequestQueue.length;)console.debug("token-expired] queue.실행 : "+n.refreshRequestQueue[r].url),n.request(n.refreshRequestQueue[r].url,n.refreshRequestQueue[r].data),o.push(n.refreshRequestQueue.shift());return o}catch(s){u=s}},error:function(e){}}),o}else{if(u&&"common.not_exist_token"===u.type)return n.state!==r.NOT_EXIST_TOKEN&&"auth/refresh"!==t?(n.state=r.NOT_EXIST_TOKEN,n.repeatTokenRequestCount++,n.request(t,s),o):void n.responseInvalidToken();(s.error&&s.error(u))!==!1&&u&&500!==u.code&&setTimeout(function(){return n.responseError(u.message)},100)}return n.fail(o),o}}(this),-1!==f.dataType.indexOf("iframe")&&(l=a,a=function(e,t,r){return e&&"undefined"==typeof e.error?l(e,t,r):c(e)},f.method="POST",f.formData=[],f.data||(f.data={}),"undefined"!=typeof f.headers.Authorization?(f.data.access_token=f.headers.Authorization,f.data.x_snackk_country=f.headers["X-SNACKK-COUNTRY"]):(f.data.client_id=f.headers["X-SNACKK-CLIENT-ID"],f.data.client_secret=f.headers["X-SNACKK-CLIENT-SECRET"],f.data.x_snackk_country=f.headers["X-SNACKK-COUNTRY"]),f.data.redirect=[location.protocol,"//",location.host].join("")+"/result?%s",8e3===parseInt(location.port,10)&&(f.data.redirect=[location.protocol,"//",location.host].join("")+"/result.html?%s"),_.forEach(f.data,function(e,t){return f.formData.push({name:t,value:e})}),f.fileInput=s.fileInput),m=setTimeout(function(e){return function(){return e.timeoutReqeust()}}(this),this.timeoutDuration),this.beforeRequest(),f.success=a,f.error=c,f.complete=s.complete,this.hasRequest[t]={},this.hasRequest[t].reqId=d,this.hasRequest[t].request=this.hasRequest[d]=$.ajax(f)},t.prototype.refreshToken=function(t){return this.request("auth/refresh",{type:"POST",data:{refresh_token:e.getRefreshToken()},success:function(e){return function(e){return t&&t.success&&t.success(e)}}(this),error:function(e){return t&&t.error&&t.error(e)},complete:function(e){return t&&t.complete&&t.complete(e)}})},t.prototype.beforeRequest=function(e){},t.prototype.fail=function(e){},t.prototype.done=function(e,t,r){},t.prototype.timeoutReqeust=function(){},t.prototype.responseInvalidToken=function(){},t.prototype.responseError=function(e){},t.prototype.TAG={auth:{refresh:"auth/refresh",clear:"auth/clear",authorize:"auth/authorize"},app:{tvs:"app/tvs",facebooktv:"app/facebooktv"},notice:"app/web",search:{target:"search/:target",url:"videos/validate"},channels:{get:"channels",ch_no:"channels/:ch_no",url:"channels/:url",broadcast:"channels/:ch_no",subscribers:"channels/:ch_no/subscribers",comments:"channels/:ch_no/comments",comment:"channels/:ch_no/comments/:cc_no"},resources:{postTemporaryResources:"user/:us_no/channels/:ch_no/resources/:operation",putTemporaryResources:"user/:us_no/channels/:ch_no/resources/:cr_no",temporaryResourcesExclude:"user/:us_no/channels/:ch_no/resources/all/:operation",temporaryResources:"user/:us_no/channels/:ch_no/resources",temporaryExclude:"user/:us_no/channels/:ch_no/resources/truncate",cancelTemporary:"user/:us_no/channels/:ch_no/histories/:hi_no",onair:"channels/:ch_no/resources",storage:"user/:us_no/resources",storageProvider:"user/:us_no/resources/:provider",storageExclude:"user/:us_no/resources/truncate",resource:"user/:us_no/resources/:rs_no"},resource:{get:"resources/:rs_no"},user:{user:"user",emailPost:"user/email/verify",aUser:"user/:us_no",profile:"user/:us_no/picture",profileDefault:"user/:us_no/picture/default",channels:"user/:us_no/channels",subscriptions:"user/:us_no/subscriptions",subscribe:"user/:us_no/subscriptions/:ch_no",channel:"user/:us_no/channels/:ch_no",channel_logo:"user/:us_no/channels/:ch_no/logo",channelLogoDefault:"channels/:ch_no/logo/default",provider:"user/:us_no/sns/:provider"},report:"reports",activity:{getActivities:"activities",read:"activities/read"},category:{categories:"categories",channels:"categories/:ca_no/channels"},timeline:{channels:"timelines/channels"},stat:{total:"channels/:ch_no/stats/:begin/:end/:step",rank:"channels/:ch_no/stats/ranking"},event:{post:"events/applicants/:target"}},t}()})}.call(this),t("request")});
//# sourceMappingURL=snackk-web-api-request.min.js.map